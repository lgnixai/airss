{"version":3,"file":"folderTree-Cp6zoTAq.js","sources":["../../../esm/services/folderTree.js"],"sourcesContent":["var __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __decorateClass = (decorators, target, key, kind) => {\n  var result = kind > 1 ? void 0 : kind ? __getOwnPropDesc(target, key) : target;\n  for (var i = decorators.length - 1, decorator; i >= 0; i--)\n    if (decorator = decorators[i])\n      result = (kind ? decorator(target, key, result) : decorator(result)) || result;\n  if (kind && result)\n    __defProp(target, key, result);\n  return result;\n};\nimport { isUndefined } from \"lodash-es\";\nimport { BaseService } from \"../glue\";\nimport { FolderTreeEvent, FolderTreeModel } from \"../models/folderTree\";\nimport {\n  FileTypes\n} from \"../types\";\nimport { searchById } from \"../utils\";\nimport { TreeHelper } from \"../utils/tree\";\nimport { injectable } from \"tsyringe\";\nlet FolderTreeService = class extends BaseService {\n  state;\n  constructor() {\n    super(\"folderTree\");\n    this.state = new FolderTreeModel();\n  }\n  addLoading(id) {\n    this.dispatch((draft) => {\n      draft.loadingKeys.push(id);\n    });\n  }\n  removeLoading(id) {\n    this.dispatch((draft) => {\n      if (isUndefined(id)) {\n        draft.loadingKeys = [];\n        return;\n      }\n      const idx = draft.loadingKeys.indexOf(id);\n      if (idx === -1)\n        return;\n      draft.loadingKeys.splice(idx, 1);\n    });\n  }\n  get(id) {\n    if (!this.getState().data.length)\n      return;\n    const treeHelper = new TreeHelper(this.getState().data);\n    return treeHelper.getNode(id);\n  }\n  getParentNode(id) {\n    if (!this.getState().data.length)\n      return;\n    const treeHelper = new TreeHelper(this.getState().data);\n    return treeHelper.getParent(id);\n  }\n  addRootFolder(data) {\n    this.dispatch((draft) => {\n      if (draft.data?.length)\n        return;\n      draft.data = [data];\n    });\n  }\n  add(data, id) {\n    const isRootFolder = data.fileType === FileTypes.RootFolder;\n    if (isRootFolder) {\n      this.addRootFolder(data);\n      return;\n    }\n    if (isUndefined(id))\n      throw new Error(\"File node or folder node both need id\");\n    this.dispatch((draft) => {\n      const treeHelper = new TreeHelper(draft.data);\n      const target = treeHelper.getNode(id);\n      if (!target)\n        return;\n      target.children ??= [];\n      target.children.push(data);\n    });\n  }\n  remove(id) {\n    this.dispatch((draft) => {\n      const treeHelper = new TreeHelper(draft.data);\n      const parent = treeHelper.getParent(id);\n      const idx = parent?.children?.findIndex(searchById(id));\n      if (idx === void 0 || idx === -1)\n        return;\n      parent?.children?.splice(idx, 1);\n    });\n  }\n  update(item, predict) {\n    this.dispatch((draft) => {\n      const treeHelper = new TreeHelper(draft.data);\n      const node = treeHelper.getNode(typeof item === \"object\" ? item.id : item);\n      if (!node)\n        return;\n      Object.assign(node, typeof item === \"object\" ? item : predict?.(node));\n    });\n    this.emit(FolderTreeEvent.onUpdate, this.get(typeof item === \"object\" ? item.id : item));\n  }\n  drop(sourceId, targetId) {\n    const source = this.get(sourceId);\n    if (!source)\n      return;\n    const target = this.get(targetId);\n    if (!target || target.fileType === FileTypes.File)\n      return;\n    this.remove(sourceId);\n    this.add(source, target.id);\n  }\n  setCurrent(id) {\n    this.emit(FolderTreeEvent.onCurrentChange, this.getCurrent(), id);\n    this.dispatch((draft) => {\n      draft.current = id;\n    });\n  }\n  getCurrent() {\n    return this.getState().current;\n  }\n  getExpanded() {\n    return this.getState().expandedKeys;\n  }\n  addExpanded(id) {\n    this.dispatch((draft) => {\n      draft.expandedKeys.push(id);\n    });\n  }\n  removeExpanded(id) {\n    this.dispatch((draft) => {\n      if (isUndefined(id)) {\n        draft.expandedKeys = [];\n        return;\n      }\n      const idx = draft.expandedKeys.indexOf(id);\n      if (idx === -1)\n        return;\n      draft.expandedKeys.splice(idx, 1);\n    });\n  }\n  toggleExpanded(id) {\n    if (this.getExpanded().includes(id)) {\n      this.removeExpanded(id);\n    } else {\n      this.addExpanded(id);\n    }\n  }\n  setValidateInfo(message) {\n    this.dispatch((draft) => {\n      draft.validateInfo = typeof message === \"string\" ? { status: \"info\", message } : message;\n    });\n  }\n  setEntry(entry) {\n    this.dispatch((draft) => {\n      draft.entry = entry;\n    });\n  }\n  setEditing(id) {\n    this.dispatch((draft) => {\n      draft.editing = id;\n    });\n  }\n  reset() {\n    this.setState(new FolderTreeModel());\n  }\n  // ===================== Subscriptions =====================\n  onRename(callback) {\n    this.subscribe(FolderTreeEvent.onRename, callback);\n  }\n  onRemove(callback) {\n    this.subscribe(FolderTreeEvent.onDelete, callback);\n  }\n  onSelect(callback) {\n    this.subscribe(FolderTreeEvent.onSelect, callback);\n  }\n  onContextMenu = (callback) => {\n    this.subscribe(FolderTreeEvent.onContextMenu, callback);\n  };\n  onContextMenuClick(callback) {\n    this.subscribe(FolderTreeEvent.onContextMenuClick, callback);\n  }\n  onExpand = (callback) => {\n    this.subscribe(FolderTreeEvent.onExpand, callback);\n  };\n  onKeyDown(callback) {\n    this.subscribe(FolderTreeEvent.onKeyDown, callback);\n  }\n  onCreateRoot(callback) {\n    this.subscribe(FolderTreeEvent.onCreateRoot, callback);\n  }\n  onUpdate(callback) {\n    this.subscribe(FolderTreeEvent.onUpdate, callback);\n  }\n  onBlur(callback) {\n    this.subscribe(FolderTreeEvent.onBlur, callback);\n  }\n  onLoad(callback) {\n    this.subscribe(FolderTreeEvent.onLoad, callback);\n  }\n  onDragStart(callback) {\n    this.subscribe(FolderTreeEvent.onDragStart, callback);\n  }\n  onDragOver = (callback) => {\n    this.subscribe(FolderTreeEvent.onDragOver, callback);\n  };\n  onDragEnd(callback) {\n    this.subscribe(FolderTreeEvent.onDragEnd, callback);\n  }\n  onDrop = (callback) => {\n    this.subscribe(FolderTreeEvent.onDrop, callback);\n  };\n  onCurrentChange(callback) {\n    this.subscribe(FolderTreeEvent.onCurrentChange, callback);\n  }\n};\nFolderTreeService = __decorateClass([\n  injectable()\n], FolderTreeService);\nexport {\n  FolderTreeService\n};\n"],"names":["__getOwnPropDesc","__decorateClass","decorators","target","key","kind","result","i","decorator","FolderTreeService","BaseService","FolderTreeModel","id","draft","isUndefined","idx","TreeHelper","data","FileTypes","parent","searchById","item","predict","node","FolderTreeEvent","sourceId","targetId","source","message","entry","callback","injectable"],"mappings":"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"}